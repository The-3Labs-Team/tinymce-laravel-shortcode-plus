<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TinyMCE Shortcode Plugin Test</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    h1 {
      color: #333;
      margin-bottom: 10px;
    }
    .info {
      background: #e3f2fd;
      padding: 12px 16px;
      border-radius: 6px;
      margin-bottom: 20px;
      font-size: 14px;
      color: #1565c0;
    }
    .editor-container {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
  </style>
  <!-- TinyMCE from CDN -->
  <script src="https://cdn.tiny.cloud/1/aggbontgwbkzf4jb6e2yziofh9mlsxrnp1o6edt6t4xg4kiz/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
</head>
<body>
  <h1>TinyMCE Shortcode Plugin Test</h1>
  <div class="info">
    <strong>Test da eseguire:</strong><br>
    1. <strong>ENTER test:</strong> Scrivi testo e premi ENTER - il nuovo paragrafo NON deve sparire<br>
    2. <strong>Shortcode preview:</strong> Gli shortcode (youtube, button, spoiler, faq) devono mostrare la preview<br>
    3. <strong>ADV preview:</strong> Dopo ogni 3 paragrafi deve apparire "Pubblicita'"<br>
    4. <strong>Edit shortcode:</strong> Clicca su una preview per aprire il dialog di modifica
  </div>

  <div class="editor-container">
    <textarea id="editor">
<p><strong>PARAGRAFO 1:</strong> Questo e' il primo paragrafo. Prova a scrivere qui e premere ENTER - il nuovo paragrafo NON deve sparire!</p>

<p><strong>PARAGRAFO 2:</strong> Secondo paragrafo con testo normale. Lorem ipsum dolor sit amet, consectetur adipiscing elit.</p>

<p><strong>PARAGRAFO 3:</strong> Terzo paragrafo - dopo questo dovrebbe apparire una ADV (ogni 3 paragrafi).</p>

<p>[youtube url="https://www.youtube.com/watch?v=dQw4w9WgXcQ"]</p>

<p><strong>PARAGRAFO 5:</strong> Quinto paragrafo dopo lo shortcode YouTube. Continua a scrivere qui...</p>

<p><strong>PARAGRAFO 6:</strong> Sesto paragrafo - dopo questo dovrebbe apparire un'altra ADV.</p>

<p>[button label="Clicca qui" url="https://example.com" level="primary"]</p>

<p><strong>PARAGRAFO 8:</strong> Ottavo paragrafo con altro testo di esempio.</p>

<p><strong>PARAGRAFO 9:</strong> Nono paragrafo - dopo questo dovrebbe apparire un'altra ADV.</p>

<p>[spoiler title="Spoiler Test"]Questo e' il contenuto nascosto dello spoiler![/spoiler]</p>

<p><strong>PARAGRAFO 11:</strong> Undicesimo paragrafo. Prova a inserire un nuovo paragrafo con ENTER qui sopra o sotto.</p>

<p><strong>PARAGRAFO 12:</strong> Dodicesimo paragrafo - dopo questo dovrebbe apparire un'altra ADV.</p>

<p>[faq title="Domanda frequente"]Questa e' la risposta alla domanda frequente.[/faq]</p>

<p><strong>PARAGRAFO 14:</strong> Quattordicesimo paragrafo. Fine del contenuto di test.</p>
    </textarea>
  </div>

  <script>
    // Mock the ads-post-parser endpoint
    const originalFetch = window.fetch;
    window.fetch = function(url, options) {
      if (url === '/ads-post-parser/get-preview-html') {
        const body = JSON.parse(options.body);
        let html = body.raw_html;

        // Simulate ADV placeholders - add [ADV PREVIEW] markers after every 2nd paragraph
        const parser = new DOMParser();
        const doc = parser.parseFromString('<div>' + html + '</div>', 'text/html');
        const paragraphs = doc.querySelectorAll('p');

        paragraphs.forEach((p, index) => {
          if ((index + 1) % 3 === 0) {
            const advMarker = doc.createElement('small');
            advMarker.textContent = '[ADV PREVIEW]';
            p.parentNode.insertBefore(advMarker, p.nextSibling);
          }
        });

        const responseHtml = '<div id="adv__parsed__content">' + doc.body.innerHTML + '</div>';

        return Promise.resolve({
          ok: true,
          json: () => Promise.resolve(responseHtml)
        });
      }

      // Pass through all other requests
      return originalFetch.apply(this, arguments);
    };

    // Load local plugins
    tinymce.PluginManager.load('preview', './src/preview.js');
    tinymce.PluginManager.load('youtube', './src/youtube.js');
    tinymce.PluginManager.load('button', './src/button.js');
    tinymce.PluginManager.load('spoiler', './src/spoiler.js');
    tinymce.PluginManager.load('faq', './src/faq.js');

    tinymce.init({
      selector: '#editor',
      height: 500,
      plugins: 'preview youtube button spoiler faq',
      toolbar: 'undo redo | blocks | bold italic | youtube button spoiler faq | preview sourcecode',
      menubar: false,
      content_style: `
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; font-size: 16px; line-height: 1.6; }
        .shortcode-preview {
          display: inline-block;
          background: #f0f0f0;
          border: 1px dashed #999;
          padding: 8px 12px;
          border-radius: 4px;
          margin: 4px 0;
        }
        .adv-preview {
          background: #fff3cd;
          border: 1px solid #ffc107;
          padding: 10px;
          margin: 10px 0;
        }
      `,
      setup: function(editor) {
        // Auto-show preview on init
        editor.on('init', function() {
          setTimeout(function() {
            editor.execCommand('showPreview');
          }, 100);
        });

        // Log cursor position for debugging
        editor.on('NodeChange', function() {
          const bookmark = editor.selection.getBookmark(2);
          console.log('Cursor position:', bookmark);
        });
      }
    });
  </script>
</body>
</html>
